# üîÑ –í–æ–∑–≤—Ä–∞—Ç RLS –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é

## üìã **–ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ**

### ‚úÖ **–û—Ç–∫–ª—é—á–µ–Ω RLS –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã users:**
```sql
-- Remove RLS from users table
ALTER TABLE users DISABLE ROW LEVEL SECURITY;

-- Drop all RLS policies
DROP POLICY IF EXISTS "Admins can view all users" ON users;
DROP POLICY IF EXISTS "Admins can insert users" ON users;
DROP POLICY IF EXISTS "Admins can update users" ON users;
DROP POLICY IF EXISTS "Users can view own profile" ON users;
DROP POLICY IF EXISTS "Users can update own profile" ON users;

-- Drop helper functions
DROP FUNCTION IF EXISTS is_admin();
DROP FUNCTION IF EXISTS get_user_role();

-- Grant all permissions back to authenticated users
GRANT SELECT, INSERT, UPDATE, DELETE ON users TO authenticated;
```

### ‚úÖ **–£–ø—Ä–æ—â–µ–Ω—ã —Ö—É–∫–∏ React:**
- **–£–±—Ä–∞–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞** –≤ `useUsers()`
- **–£–±—Ä–∞–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `isAdmin`** –∏–∑ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- **–£–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞** –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üîß **–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**

### ‚úÖ **–¢–∞–±–ª–∏—Ü–∞ users:**
- ‚ùå **RLS –æ—Ç–∫–ª—é—á–µ–Ω** - –Ω–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ **–í—Å–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** –∏–º–µ—é—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
- ‚úÖ **–ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫
- ‚úÖ **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫

### ‚úÖ **–•—É–∫–∏ React:**
```typescript
// useUsers() - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
const { users, loading, error, addUser, updateUser, deleteUser, refresh } = useUsers()

// useUserRole() - –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
const { role, isAdmin, loading, error, refresh } = useUserRole()
```

## üöÄ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞**

### ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:**
- **–ù–µ—Ç —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫** RLS
- **–ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞** –≤ –∫–æ–¥–µ
- **–õ–µ–≥–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –∏ –æ—Ç–ª–∞–¥–∫–∞
- **–ú–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫** SQL

### ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- **–ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
- **–ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏** –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- **–ü—Ä–æ—Å—Ç–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å:**
- **–õ–µ–≥–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- **–ü—Ä–æ—Å—Ç–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ** –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- **–ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**

### ‚úÖ **–ó–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
const { isAdmin } = useUserRole()

if (isAdmin) {
  // –ü–æ–∫–∞–∑–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  return <AdminPanel />
} else {
  // –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  return <UserPanel />
}
```

### ‚úÖ **–ó–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ —Ö—É–∫–∏:**
```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –≤ —Ö—É–∫–∞—Ö
const { role } = useUserRole()

if (role === 'admin') {
  // –í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
  const { users } = useUsers()
} else {
  // –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –¥–æ—Å—Ç—É–ø
  setError('Access denied')
}
```

## üìù **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é**

### üìã **–®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SQL —Å–∫—Ä–∏–ø—Ç–∞**
1. –û—Ç–∫—Ä–æ–π—Ç–µ **Supabase Dashboard**
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **SQL Editor**
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç `database/users_rls_policies.sql`

### üìã **–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è RLS
SELECT schemaname, tablename, rowsecurity 
FROM pg_tables 
WHERE tablename = 'users';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
SELECT * FROM users LIMIT 5;
```

### üìã **–®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏**
```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—É–∫–∞ useUsers
const { users, loading, error } = useUsers()
console.log('Users:', users)

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ö—É–∫–∞ useUserRole
const { role, isAdmin } = useUserRole()
console.log('Role:', role, 'Is Admin:', isAdmin)
```

## üéØ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

### ‚úÖ **–ü–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞:**
- ‚úÖ **–ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞** –±–µ–∑ RLS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- ‚úÖ **–õ–µ–≥–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚úÖ **–ü—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** –∏ –æ—Ç–ª–∞–¥–∫–∞
- ‚úÖ **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å** –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

### ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- üîí **–ó–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** —á–µ—Ä–µ–∑ React
- üîí **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π** –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö –∏ —Ö—É–∫–∞—Ö
- üîí **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ —Å–µ—Ä–≤–µ—Ä–µ
- üîí **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** —á–µ—Ä–µ–∑ Supabase Auth

## üîÑ **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ RLS**

### üìù **–ï—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è RLS –≤ –±—É–¥—É—â–µ–º:**
1. **–í–∫–ª—é—á–∏—Ç—å RLS:** `ALTER TABLE users ENABLE ROW LEVEL SECURITY;`
2. **–°–æ–∑–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏** —Å–Ω–æ–≤–∞
3. **–û–±–Ω–æ–≤–∏—Ç—å —Ö—É–∫–∏** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### üìù **–§–∞–π–ª—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:**
- `database/users_rls_policies.sql` - –ø–æ–ª–∏—Ç–∏–∫–∏ RLS
- `src/hooks/useSupabase.ts` - —Ö—É–∫–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
- `USERS_RLS_FINAL_FIX.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è RLS

## üéØ **–ì–æ—Ç–æ–≤–æ!**

–¢–µ–ø–µ—Ä—å —Ç–∞–±–ª–∏—Ü–∞ `users` —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ø—Ä–æ—Å—Ç–æ–º —Ä–µ–∂–∏–º–µ:
- ‚ùå **–ë–µ–∑ RLS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π**
- ‚úÖ **–° –ø–æ–ª–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º** –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ **–° –ø—Ä–æ—Å—Ç–æ–π –ª–æ–≥–∏–∫–æ–π** –≤ –∫–æ–¥–µ
- ‚úÖ **–° –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é**
- ‚úÖ **–° –∑–∞—â–∏—Ç–æ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**

–í—Å–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–π –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã! üöÄ 