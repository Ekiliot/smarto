# üîí –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã users

## üêõ **–ü—Ä–æ–±–ª–µ–º–∞**
–û—à–∏–±–∫–∞ `ERROR: 42P01: missing FROM-clause entry for table "old"` –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `OLD` –∏ `NEW` –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö.

## ‚úÖ **–†–µ—à–µ–Ω–∏–µ**
–£–ø—Ä–æ—â–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Supabase.

## üìã **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏**

### ‚úÖ **1. –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤**

#### üëÅÔ∏è **–ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
```sql
CREATE POLICY "Admins can view all users" ON users
    FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM users
            WHERE users.id = auth.uid()
            AND users.role = 'admin'
        )
    );
```

#### ‚ûï **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
```sql
CREATE POLICY "Admins can insert users" ON users
    FOR INSERT
    WITH CHECK (
        EXISTS (
            SELECT 1 FROM users
            WHERE users.id = auth.uid()
            AND users.role = 'admin'
        )
    );
```

#### ‚úèÔ∏è **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
```sql
CREATE POLICY "Admins can update users" ON users
    FOR UPDATE
    USING (
        EXISTS (
            SELECT 1 FROM users
            WHERE users.id = auth.uid()
            AND users.role = 'admin'
        )
    )
    WITH CHECK (
        EXISTS (
            SELECT 1 FROM users
            WHERE users.id = auth.uid()
            AND users.role = 'admin'
        )
    );
```

### ‚úÖ **2. –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

#### üë§ **–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:**
```sql
CREATE POLICY "Users can view own profile" ON users
    FOR SELECT
    USING (auth.uid() = id);
```

#### ‚úèÔ∏è **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:**
```sql
CREATE POLICY "Users can update own profile" ON users
    FOR UPDATE
    USING (auth.uid() = id);
```

## üîß **–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**

### ‚úÖ **–£–±—Ä–∞–Ω—ã —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚ùå **–£–¥–∞–ª–µ–Ω—ã** –ø—Ä–æ–≤–µ—Ä–∫–∏ `OLD` –∏ `NEW` (–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤ RLS)
- ‚ùå **–£–¥–∞–ª–µ–Ω—ã** —Å–ª–æ–∂–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —Å `DISTINCT FROM`
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã** –ø—Ä–æ—Å—Ç—ã–µ –∏ –Ω–∞–¥–µ–∂–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏

### ‚úÖ **–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞:**
- **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã** - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –æ–ø–µ—Ä–∞—Ü–∏—è–º
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** - –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–µ–º—É –ø—Ä–æ—Ñ–∏–ª—é
- **–ó–∞—â–∏—Ç–∞ —Ä–æ–ª–∏** - —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## üöÄ **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π**

### üìù **–®–∞–≥ 1: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª–∏—Ç–∏–∫**
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase SQL Editor
DROP POLICY IF EXISTS "Users can view own profile" ON users;
DROP POLICY IF EXISTS "Admins can view all users" ON users;
DROP POLICY IF EXISTS "Admins can insert users" ON users;
DROP POLICY IF EXISTS "Admins can update all users" ON users;
DROP POLICY IF EXISTS "Admins can delete users" ON users;
DROP POLICY IF EXISTS "Users can update own profile" ON users;
```

### üìù **–®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–∏—Ç–∏–∫**
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç database/users_rls_policies.sql
```

### üìù **–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
SELECT * FROM users;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT * FROM users WHERE id = auth.uid();
```

## üõ°Ô∏è **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**

### ‚úÖ **–ß—Ç–æ –∑–∞—â–∏—â–µ–Ω–æ:**
- **–î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º:** –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –≤–∏–¥—è—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
- **–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —É–¥–∞–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### ‚úÖ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞:**
- **–ó–∞—â–∏—Ç–∞ —Ä–æ–ª–∏** —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –≤ —Ö—É–∫–∞—Ö React
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤** –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–π

## üîß **–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ö—É–∫–∏**

### ‚úÖ **useUsers Hook:**
```typescript
const { users, loading, error, isAdmin } = useUsers()
```
- **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞** –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
- **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É** –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤
- **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø** –∫ –¥–∞–Ω–Ω—ã–º

### ‚úÖ **useUserRole Hook:**
```typescript
const { role, isAdmin, loading, error } = useUserRole()
```
- **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–æ–ª—å** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ö—ç—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç** –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞** –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

## üéØ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

### ‚úÖ **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞** RLS –ø–æ–ª–∏—Ç–∏–∫
- ‚úÖ **–ë–µ–∑ –æ—à–∏–±–æ–∫** –≤ SQL –∑–∞–ø—Ä–æ—Å–∞—Ö
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø** –∫ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ **–ü—Ä–æ—Å—Ç–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è** –ª–æ–≥–∏–∫–∞
- ‚úÖ **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

### ‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
const { isAdmin } = useUserRole()

if (isAdmin) {
  // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  const { users } = useUsers()
} else {
  // –û–±—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
}
```

## üéØ **–ì–æ—Ç–æ–≤–æ!**

–¢–µ–ø–µ—Ä—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø** –∫ —Ç–∞–±–ª–∏—Ü–µ users
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞** –±–µ–∑ –æ—à–∏–±–æ–∫ SQL
- üëë **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏** –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
- üë§ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ö° **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å 